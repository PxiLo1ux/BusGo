generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PASSENGER
  DRIVER
  ADMIN
}

enum DriverStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BusType {
  STANDARD
  DELUXE
  TOURIST
}

enum ScheduleStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DELAYED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum PaymentMethod {
  ONLINE
  CASH
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
}

enum NotificationType {
  BOOKING_CONFIRMATION
  TRIP_REMINDER
  BOOKING_CANCELLED
  DRIVER_NEW_BOOKING
  REVIEW_REQUEST
  LOYALTY_EARNED
  PROMOTION
  GENERAL
  NEW_MESSAGE
  SCHEDULE_UPDATE
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String
  name           String
  phone          String?
  profilePicture String?  // Base64 image for avatar
  role           Role     @default(PASSENGER)
  referralCode   String   @unique @default(uuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  driver          Driver?
  bookings        Booking[]
  reviews         Review[]
  loyalty         LoyaltyPoints?
  notifications   Notification[]
  supportTickets  SupportTicket[]
  chatMessages    ChatMessage[]
  bookingChats    BookingChat[]     @relation("BookingChats")
  driverRatings   DriverRating[]
  referralsMade   Referral[]        @relation("ReferralsMade")
  referralsReceived Referral[]      @relation("ReferralsReceived")
}

model Driver {
  id            String       @id @default(uuid())
  userId        String       @unique
  licenseNumber String       @unique
  phone         String
  status        DriverStatus @default(PENDING)
  rating        Float        @default(0)
  totalReviews  Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  buses         Bus[]
  driverRatings DriverRating[]
}

model Bus {
  id                  String   @id @default(uuid())
  driverId            String
  name                String
  plateNumber         String   @unique
  capacity            Int
  type                BusType  @default(DELUXE)
  approved            Boolean  @default(false)
  amenities           String[]
  hasToilet           Boolean  @default(false)
  rating              Float    @default(0)
  totalReviews        Int      @default(0)
  // Sub-driver/employed driver info
  employedDriverName  String?
  employedDriverPhone String?
  // Document uploads (base64 or URLs)
  photos              String[]
  bluebookImage       String?
  taxClearance        String?
  insuranceDoc        String?
  documentsVerified   Boolean  @default(false)
  // Primary route assignment
  primaryRouteId      String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  driver         Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  primaryRoute   Route?          @relation("BusPrimaryRoute", fields: [primaryRouteId], references: [id])
  schedules      Schedule[]
  locations      BusLocation[]
  dailySchedules DailySchedule[]
}

// Daily schedule templates - defines recurring daily trips
model DailySchedule {
  id              String   @id @default(uuid())
  busId           String
  routeId         String
  departureTime   String   // Time only, e.g., "06:00"
  arrivalTime     String   // Time only, e.g., "12:30"  
  price           Float
  isActive        Boolean  @default(true)
  isReturnTrip    Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bus   Bus   @relation(fields: [busId], references: [id], onDelete: Cascade)
  route Route @relation(fields: [routeId], references: [id])

  @@unique([busId, routeId, departureTime])
}

model Route {
  id             String   @id @default(uuid())
  origin         String
  destination    String
  distance       Float
  estimatedTime  Int
  baseFare       Float
  waypoints      String[]
  // Coordinates for map
  originLat      Float?
  originLng      Float?
  destinationLat Float?
  destinationLng Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  schedules      Schedule[]
  pricingRules   PricingRule[]
  dailySchedules DailySchedule[]
  primaryBuses   Bus[]           @relation("BusPrimaryRoute")

  @@unique([origin, destination])
}

model Schedule {
  id               String         @id @default(uuid())
  busId            String
  routeId          String
  departureTime    DateTime
  arrivalTime      DateTime
  price            Float
  dynamicPrice     Float?         // Calculated dynamic price
  availableSeats   Int
  status           ScheduleStatus @default(SCHEDULED)
  recurring        Boolean        @default(false)
  recurringDays    String[]
  // Two-way schedule support
  returnScheduleId String?        // Links to return trip
  isReturnTrip     Boolean        @default(false)
  // Delay support (max 6 hours = 360 minutes)
  delayMinutes     Int            @default(0)
  delayReason      String?
  originalDepartureTime DateTime?
  // Link to daily schedule template
  dailyScheduleId  String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  bus          Bus           @relation(fields: [busId], references: [id], onDelete: Cascade)
  route        Route         @relation(fields: [routeId], references: [id])
  bookings     Booking[]
  seats        Seat[]
  reviews      Review[]
  busLocations BusLocation[]
}

model Seat {
  id         String  @id @default(uuid())
  scheduleId String
  name       String
  row        Int
  column     String
  position   String  @default("REGULAR")
  isBooked   Boolean @default(false)

  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, name])
}

model Booking {
  id             String        @id @default(uuid())
  userId         String
  scheduleId     String
  seats          String[]
  totalAmount    Float
  discountAmount Float         @default(0)
  loyaltyUsed    Int           @default(0)
  status         BookingStatus @default(PENDING)
  paymentMethod  PaymentMethod @default(ONLINE)
  passengerName  String?
  passengerEmail String?
  passengerPhone String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user         User           @relation(fields: [userId], references: [id])
  schedule     Schedule       @relation(fields: [scheduleId], references: [id])
  payment      Payment?
  review       Review?
  messages     BookingChat[]
  driverRating DriverRating?
}

model BookingChat {
  id        String   @id @default(uuid())
  bookingId String
  senderId  String
  content   String
  createdAt DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender  User    @relation("BookingChats", fields: [senderId], references: [id])
}

model Payment {
  id              String        @id @default(uuid())
  bookingId       String        @unique
  amount          Float
  currency        String        @default("NPR")
  status          PaymentStatus @default(PENDING)
  method          PaymentMethod @default(ONLINE)
  stripePaymentId String?
  createdAt       DateTime      @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

// NEW MODELS

model Review {
  id         String   @id @default(uuid())
  userId     String
  bookingId  String   @unique
  scheduleId String
  rating     Int      // 1-5
  comment    String?
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  schedule Schedule @relation(fields: [scheduleId], references: [id])
}

model LoyaltyPoints {
  id          String      @id @default(uuid())
  userId      String      @unique
  points      Int         @default(0)
  tier        LoyaltyTier @default(BRONZE)
  totalEarned Int         @default(0)
  updatedAt   DateTime    @updatedAt

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions LoyaltyTransaction[]
}

model LoyaltyTransaction {
  id          String   @id @default(uuid())
  loyaltyId   String
  type        String   // EARNED, REDEEMED
  points      Int
  description String
  createdAt   DateTime @default(now())

  loyalty LoyaltyPoints @relation(fields: [loyaltyId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PricingRule {
  id            String    @id @default(uuid())
  routeId       String?
  name          String
  type          String    // SURGE, EARLY_BIRD, SEASONAL, DISCOUNT
  multiplier    Float     // e.g., 1.2 = 20% increase
  startDate     DateTime?
  endDate       DateTime?
  minDaysBefore Int?      // For early bird/surge (days)
  minHoursBefore Int?     // For surge pricing (hours)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())

  route Route? @relation(fields: [routeId], references: [id], onDelete: Cascade)
}

model SupportTicket {
  id          String   @id @default(uuid())
  userId      String?
  email       String
  category    String   // booking, payment, driver, refund, other
  description String
  status      String   @default("open") // open, in_progress, resolved, closed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages ChatMessage[]
}

model ChatMessage {
  id        String   @id @default(uuid())
  ticketId  String
  senderId  String?
  content   String
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User?         @relation(fields: [senderId], references: [id], onDelete: SetNull)
}

model LoyaltyOffer {
  id              String   @id @default(uuid())
  name            String
  description     String
  pointsCost      Int
  discountPercent Int
  category        String   // discount, upgrade, free_trip, special
  validUntil      DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
}

// Driver Rating System
model DriverRating {
  id        String   @id @default(uuid())
  driverId  String
  userId    String
  bookingId String   @unique
  rating    Int      // 1-5 stars
  comment   String?
  createdAt DateTime @default(now())

  driver  Driver  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

// Live Bus Tracking
model BusLocation {
  id         String   @id @default(uuid())
  busId      String
  scheduleId String
  latitude   Float
  longitude  Float
  speed      Float?   // km/h
  heading    Float?   // degrees
  updatedAt  DateTime @default(now())

  bus      Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
}

// Referral System
model Referral {
  id           String   @id @default(uuid())
  referrerId   String
  referredId   String
  code         String
  pointsEarned Int      @default(0)
  status       String   @default("PENDING") // PENDING, COMPLETED
  createdAt    DateTime @default(now())
  completedAt  DateTime?

  referrer User @relation("ReferralsMade", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User @relation("ReferralsReceived", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId])
}

// Saved Locations for waypoints autocomplete
model Location {
  id         String   @id @default(uuid())
  name       String   @unique
  district   String?
  latitude   Float?
  longitude  Float?
  usageCount Int      @default(1)
  createdAt  DateTime @default(now())
}
